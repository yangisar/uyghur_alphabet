<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uyghur and Old Turkic Alphabet Practice Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Harmonious September Garden Palette */
            --bg-deep: #283618;        /* Forest Moss */
            --bg-mid: #606c38;         /* Sage Leaf */
            --accent-clay: #bc6c25;    /* Dried Earth */
            --accent-wheat: #fefae0;   /* Harvest Cream */
            --accent-gold: #dda15e;    /* Golden Hour */
            --danger: #ae2012;         /* Autumn Berry Red */
            --success: #52b788;        /* Match Green */
            
            --pixel-font: 'Press Start 2P', cursive;
        }

        body { 
            font-family: var(--pixel-font); 
            background: var(--bg-deep); 
            color: var(--accent-wheat);
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            overflow-x: hidden;
            text-transform: uppercase;
        }

        /* Scanline Texture Overlay */
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            z-index: 1000;
            background-size: 100% 4px;
            pointer-events: none;
        }

        .screen { display: none; width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; flex-direction: column; flex-grow: 1; }
        .active { display: flex; }

        h1 { 
            font-size: 14px; 
            text-align: center; 
            color: var(--accent-gold); 
            text-shadow: 3px 3px var(--bg-deep); 
            margin: 20px 0 30px 0;
            line-height: 1.6;
        }

        h2 {
            font-size: 11px;
            text-align: center;
            color: var(--accent-wheat);
            margin: 10px 0 20px 0;
            line-height: 1.6;
            font-weight: normal;
        }

        /* Menu Styles */
        .menu-card { 
            border: 4px solid var(--bg-mid); 
            padding: 25px; 
            background: rgba(0,0,0,0.2); 
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            border-radius: 4px;
            margin-bottom: 15px;
        }

        /* Script Choice Cards */
        .script-choice {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .script-card {
            border: 4px solid var(--bg-mid);
            padding: 30px 25px;
            background: rgba(0,0,0,0.3);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .script-card:hover {
            border-color: var(--accent-gold);
            background: rgba(0,0,0,0.4);
            transform: translateY(-2px);
            box-shadow: 10px 10px 0px rgba(0,0,0,0.3);
        }

        .script-card:active {
            transform: translateY(2px);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        .script-title {
            font-size: 12px;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .script-sample {
            font-size: 48px;
            color: var(--accent-wheat);
            margin: 15px 0;
            line-height: 1.4;
        }

        .script-sample.uyghur {
            font-family: "Microsoft Uighur", serif;
            text-transform: none;
        }

        .script-sample.orkhon {
            font-family: "Segoe UI Historic", "Noto Sans Old Turkic", serif;
            text-transform: none;
        }

        .script-desc {
            font-size: 8px;
            color: var(--accent-wheat);
            opacity: 0.7;
            line-height: 1.6;
            margin-top: 10px;
        }

        .option-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-size: 9px; color: var(--accent-gold); }
        
        select { 
            width: 100%; padding: 12px; background: var(--bg-deep); color: var(--accent-wheat); 
            border: 2px solid var(--accent-gold); font-family: var(--pixel-font); font-size: 10px;
            outline: none;
        }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .switch {
            width: 50px; height: 24px; background: #333; border: 2px solid var(--accent-gold);
            position: relative; transition: 0.3s;
        }
        .switch::after {
            content: ''; position: absolute; width: 16px; height: 16px; 
            background: var(--accent-wheat); top: 2px; left: 2px; transition: 0.3s;
        }
        input:checked + .switch { background: var(--accent-clay); }
        input:checked + .switch::after { left: 28px; }

        /* HUD */
        .hud { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 10px; height: 30px; }
        .lives-box { color: var(--danger); }

        /* Memory Cards */
        .game-board { display: grid; grid-gap: 12px; width: 100%; }
        .card { height: 115px; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            display: flex; align-items: center; justify-content: center; 
            border: 3px solid var(--bg-mid); border-radius: 6px;
            transition: all 0.3s;
        }
        .card-front { background: var(--bg-mid); background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px); }
        .card-back { background: var(--bg-deep); transform: rotateY(180deg); color: var(--accent-gold); font-size: 16px; box-shadow: inset 0 0 15px rgba(0,0,0,0.4); }
        
        /* Matched cards get pleasant warm golden color */
        .card.matched .card-face { 
            border-color: #f4a261;
            background: linear-gradient(135deg, rgba(244, 162, 97, 0.25) 0%, rgba(233, 196, 106, 0.2) 100%);
            box-shadow: 0 0 20px rgba(244, 162, 97, 0.3);
        }
        .card.matched .card-back {
            color: #f4a261;
            box-shadow: inset 0 0 25px rgba(244, 162, 97, 0.4);
            background: linear-gradient(135deg, rgba(40, 54, 24, 0.8) 0%, rgba(60, 80, 40, 0.6) 100%);
        }
        .card.matched .card-front {
            background: linear-gradient(135deg, rgba(244, 162, 97, 0.3) 0%, rgba(233, 196, 106, 0.25) 100%);
        }

        .is-uyghur { font-family: "Microsoft Uighur", serif; font-size: 48px; text-transform: none; }
        .is-orkhon { font-family: "Segoe UI Historic", "Noto Sans Old Turkic", serif; font-size: 36px; text-transform: none; }

        /* Drawing Pad */
        .draw-container { 
            position: relative; width: 100%; height: 320px; background: #1a1a1a; 
            border: 4px solid var(--accent-gold); margin-bottom: 15px; touch-action: none; 
        }
        
        .ghost-preview {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 64px;
            color: rgba(221, 161, 94, 0.15);
            pointer-events: none;
            z-index: 1;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .ghost-preview.is-uyghur {
            font-family: "Microsoft Uighur", serif;
            text-transform: none;
        }
        
        .ghost-preview.is-orkhon {
            font-family: "Segoe UI Historic", "Noto Sans Old Turkic", serif;
            text-transform: none;
        }
        
        canvas { width: 100%; height: 100%; cursor: crosshair; position: relative; z-index: 2; }

        /* Footer */
        footer {
            margin-top: auto; padding: 20px; font-size: 7px; text-align: center;
            color: var(--accent-gold); line-height: 1.8; opacity: 0.8;
        }
        footer a { color: var(--accent-wheat); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .ig-icon { width: 10px; height: 10px; fill: var(--accent-wheat); }

        /* Buttons */
        .btn { 
            background: var(--accent-clay); color: var(--accent-wheat); border: none; padding: 15px; 
            font-family: var(--pixel-font); font-size: 11px; cursor: pointer; margin-bottom: 10px;
            box-shadow: 4px 4px 0px #5e3412; width: 100%;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #5e3412; }
        .btn-menu { background: none; color: var(--accent-gold); border: 2px solid var(--accent-gold); font-size: 8px; padding: 5px 8px; }
        .btn-secondary { background: var(--bg-mid); box-shadow: 4px 4px 0 var(--bg-deep); }
        
        /* Reference Sheet Button - Above footer, smaller */
        .btn-reference {
            background: var(--accent-gold);
            color: var(--bg-deep);
            border: 2px solid var(--bg-deep);
            font-size: 7px;
            padding: 8px 10px;
            cursor: pointer;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.4);
            font-family: var(--pixel-font);
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 8px;
        }
        .btn-reference:hover {
            background: var(--accent-wheat);
            transform: translateY(-1px);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.4);
        }
        .btn-reference:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px rgba(0,0,0,0.4);
        }
        
        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        
        /* Reference Sheet Modal */
        .reference-modal {
            background: var(--bg-deep);
            border: 4px solid var(--accent-gold);
            padding: 25px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .reference-modal h2 {
            font-size: 12px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .reference-table th {
            background: var(--bg-mid);
            color: var(--accent-wheat);
            padding: 10px 8px;
            font-size: 8px;
            border: 2px solid var(--bg-deep);
            text-align: center;
        }
        
        .reference-table td {
            padding: 12px 8px;
            border: 2px solid var(--bg-mid);
            text-align: center;
            font-size: 10px;
            color: var(--accent-wheat);
        }
        
        .reference-table tr:nth-child(even) {
            background: rgba(0,0,0,0.2);
        }
        
        .reference-table .native-script {
            font-size: 24px;
        }
        
        .reference-table .uyghur-cell {
            font-family: "Microsoft Uighur", serif;
            text-transform: none;
        }
        
        .reference-table .orkhon-cell {
            font-family: "Segoe UI Historic", "Noto Sans Old Turkic", serif;
            text-transform: none;
        }
        
        .modal-close {
            background: var(--accent-clay);
            color: var(--accent-wheat);
            border: none;
            padding: 12px;
            font-family: var(--pixel-font);
            font-size: 9px;
            cursor: pointer;
            width: 100%;
            box-shadow: 4px 4px 0px #5e3412;
        }
        
        .modal-close:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #5e3412;
        }
        
        /* Progress indicator */
        .progress-badge {
            display: inline-block;
            background: var(--accent-clay);
            color: var(--accent-wheat);
            padding: 8px 12px;
            font-size: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <!-- MAIN SCREEN: Choose Script Type -->
    <div id="mainScreen" class="screen active">
        <h1>Uyghur and Old Turkic<br>Alphabet Practice Game</h1>
        <div id="savedProgress" class="progress-badge" style="display:none;"></div>
        <h2>Choose Your Script</h2>
        
        <div class="script-choice">
            <div class="script-card" onclick="selectScript('uyghur')">
                <div class="script-title">Uyghur Kona Y√´ziq</div>
                <div class="script-sample uyghur">ÿ¶€áŸäÿ∫€áÿ± Ÿä€êÿ≤ŸâŸÇŸâ</div>
                <div class="script-desc">Perso-Arabic Script</div>
            </div>

            <div class="script-card" onclick="selectScript('orkhon')">
                <div class="script-title">G√∂kt√ºrk, Orkhon,<br>Orkhon-Yenisey Script</div>
                <div class="script-sample orkhon">ê±Öê∞áê∞ºê∞ú</div>
                <div class="script-desc">Old Turkic Script</div>
            </div>
        </div>
    </div>

    <!-- OPTIONS SCREEN -->
    <div id="setupScreen" class="screen">
        <h1 id="scriptHeader">Practice Options</h1>
        <div class="menu-card">
            <div class="option-group">
                <label>SELECT MODE</label>
                <select id="gameMode">
                    <option value="memory">MEMORY MATCH</option>
                    <option value="draw">TRACE DRAW</option>
                </select>
            </div>
            <div class="option-group">
                <label>SCRIPT TO MATCH WITH</label>
                <select id="scriptType">
                    <option value="latin">LATIN</option>
                    <option value="cyrillic">CYRILLIC</option>
                </select>
            </div>
            <div class="option-group">
                <label>CONTENT</label>
                <select id="contentType">
                    <option value="alphabet">SINGLE LETTERS</option>
                    <option value="words">LETTER COMBINATIONS</option>
                </select>
            </div>
            <div class="option-group">
                <label class="toggle-container">
                    <span>ENABLE STAKES (7 LIVES)</span>
                    <input type="checkbox" id="stakesToggle" style="display:none">
                    <div class="switch"></div>
                </label>
            </div>
            <button class="btn" onclick="startGame()">START PRACTICE</button>
            <button class="btn btn-secondary" onclick="backToMain()">BACK</button>
        </div>
    </div>

    <!-- MEMORY GAME SCREEN -->
    <div id="memoryScreen" class="screen">
        <div class="hud">
            <span id="lvlDisplay">LVL: 01</span>
            <span id="livesContainer" class="lives-box"></span>
            <button class="btn-menu" onclick="showMenu()">QUIT</button>
        </div>
        <div id="gameBoard" class="game-board"></div>
    </div>

    <!-- DRAWING SCREEN -->
    <div id="drawScreen" class="screen">
        <div class="hud">
            <h2 id="drawTarget" style="font-size:14px; color:var(--accent-gold); margin:0;">A</h2>
            <button class="btn-menu" onclick="showMenu()">QUIT</button>
        </div>
        <div class="draw-container">
            <div id="ghostLetter" class="ghost-preview"></div>
            <canvas id="drawCanvas"></canvas>
        </div>
        <button class="btn" onclick="nextDrawing()">NEXT LETTER</button>
        <button class="btn btn-secondary" onclick="clearCanvas()">RESET PAD</button>
    </div>

    <footer>
        <button class="btn-reference" onclick="toggleReference()">üìã ALPHABET REFERENCE</button><br>
        Created using AI tools by Yadykar Ibraimov<br>
        Follow 
        <a href="https://instagram.com/yangisar/" target="_blank">
            <svg class="ig-icon" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            @yangisar
        </a>
    </footer>

    <!-- Reference Sheet Modal -->
    <div id="referenceModal" class="modal-overlay">
        <div class="reference-modal">
            <h2>Alphabet Reference Sheet</h2>
            <table class="reference-table" id="referenceTable">
                <!-- Generated by JavaScript -->
            </table>
            <button class="modal-close" onclick="toggleReference()">CLOSE</button>
        </div>
    </div>

    <script>
        // Alphabet data for both scripts - COMPLETE 32 LETTERS
        const uyghurAlphabet = [
            { latin: "A", cyrillic: "–ê", uyghur: "ÿ¶ÿß" }, 
            { latin: "E", cyrillic: "”ò", uyghur: "ÿ¶€ï" },
            { latin: "B", cyrillic: "–ë", uyghur: "ÿ®" }, 
            { latin: "P", cyrillic: "–ü", uyghur: "Ÿæ" },
            { latin: "T", cyrillic: "–¢", uyghur: "ÿ™" }, 
            { latin: "J", cyrillic: "“ñ", uyghur: "ÿ¨" },
            { latin: "Ch", cyrillic: "–ß", uyghur: "⁄Ü" }, 
            { latin: "X", cyrillic: "–•", uyghur: "ÿÆ" },
            { latin: "D", cyrillic: "–î", uyghur: "ÿØ" }, 
            { latin: "R", cyrillic: "–†", uyghur: "ÿ±" },
            { latin: "Z", cyrillic: "–ó", uyghur: "ÿ≤" },
            { latin: "Zh", cyrillic: "–ñ", uyghur: "⁄ò" },
            { latin: "S", cyrillic: "–°", uyghur: "ÿ≥" },
            { latin: "Sh", cyrillic: "–®", uyghur: "ÿ¥" }, 
            { latin: "Gh", cyrillic: "“í", uyghur: "ÿ∫" },
            { latin: "F", cyrillic: "–§", uyghur: "ŸÅ" },
            { latin: "Q", cyrillic: "“ö", uyghur: "ŸÇ" }, 
            { latin: "K", cyrillic: "–ö", uyghur: "ŸÉ" },
            { latin: "G", cyrillic: "–ì", uyghur: "⁄Ø" },
            { latin: "Ng", cyrillic: "“¢", uyghur: "⁄≠" },
            { latin: "L", cyrillic: "–õ", uyghur: "ŸÑ" },
            { latin: "M", cyrillic: "–ú", uyghur: "ŸÖ" }, 
            { latin: "N", cyrillic: "–ù", uyghur: "ŸÜ" },
            { latin: "H", cyrillic: "“∫", uyghur: "⁄æ" },
            { latin: "O", cyrillic: "–û", uyghur: "ÿ¶Ÿà" },
            { latin: "U", cyrillic: "–£", uyghur: "ÿ¶€á" },
            { latin: "√ñ", cyrillic: "”®", uyghur: "ÿ¶€Ü" },
            { latin: "√ú", cyrillic: "“Æ", uyghur: "ÿ¶€à" },
            { latin: "W", cyrillic: "–í", uyghur: "€ã" },
            { latin: "√â", cyrillic: "–ï", uyghur: "ÿ¶€ê" },
            { latin: "I", cyrillic: "–ò", uyghur: "ÿ¶Ÿâ" }, 
            { latin: "Y", cyrillic: "–ô", uyghur: "Ÿä" }
        ];

        const orkhonAlphabet = [
            { latin: "A", cyrillic: "–ê", orkhon: "ê∞Ä" }, 
            { latin: "E", cyrillic: "”ò", orkhon: "ê∞Ä" },
            { latin: "B", cyrillic: "–ë", orkhon: "ê∞ã" }, 
            { latin: "P", cyrillic: "–ü", orkhon: "ê∞Ø" },
            { latin: "T", cyrillic: "–¢", orkhon: "ê±Ö" }, 
            { latin: "J", cyrillic: "“ñ", orkhon: "ê∞≤" },
            { latin: "Ch", cyrillic: "–ß", orkhon: "ê∞≤" }, 
            { latin: "X", cyrillic: "–•", orkhon: "ê∞¥" },
            { latin: "D", cyrillic: "–î", orkhon: "ê∞ë" }, 
            { latin: "R", cyrillic: "–†", orkhon: "ê∞∫" },
            { latin: "Z", cyrillic: "–ó", orkhon: "ê∞î" },
            { latin: "Zh", cyrillic: "–ñ", orkhon: "ê∞≤" },
            { latin: "S", cyrillic: "–°", orkhon: "ê∞Ω" },
            { latin: "Sh", cyrillic: "–®", orkhon: "ê±Å" }, 
            { latin: "Gh", cyrillic: "“í", orkhon: "ê∞ç" },
            { latin: "F", cyrillic: "–§", orkhon: "ê∞Ø" },
            { latin: "Q", cyrillic: "“ö", orkhon: "ê∞¥" }, 
            { latin: "K", cyrillic: "–ö", orkhon: "ê∞ö" },
            { latin: "G", cyrillic: "–ì", orkhon: "ê∞è" },
            { latin: "Ng", cyrillic: "“¢", orkhon: "ê∞≠" },
            { latin: "L", cyrillic: "–õ", orkhon: "ê∞†" },
            { latin: "M", cyrillic: "–ú", orkhon: "ê∞¢" }, 
            { latin: "N", cyrillic: "–ù", orkhon: "ê∞§" },
            { latin: "H", cyrillic: "“∫", orkhon: "ê∞¥" },
            { latin: "O", cyrillic: "–û", orkhon: "ê∞Ü" },
            { latin: "U", cyrillic: "–£", orkhon: "ê∞Ü" },
            { latin: "√ñ", cyrillic: "”®", orkhon: "ê∞á" },
            { latin: "√ú", cyrillic: "“Æ", orkhon: "ê∞á" },
            { latin: "W", cyrillic: "–í", orkhon: "ê∞ã" },
            { latin: "√â", cyrillic: "–ï", orkhon: "ê∞Ä" },
            { latin: "I", cyrillic: "–ò", orkhon: "ê∞É" }, 
            { latin: "Y", cyrillic: "–ô", orkhon: "ê∞ñ" }
        ];

        let selectedScriptType = 'uyghur'; // 'uyghur' or 'orkhon'
        let currentAlphabet = uyghurAlphabet;
        let targetScriptKey = 'uyghur'; // What script to match against

        function getCombinations(alphabet, scriptKey) {
            let combos = [];
            const vowels = alphabet.filter(l => "AEIOU".includes(l.latin));
            const cons = alphabet.filter(l => !"AEIOU".includes(l.latin));
            for(let i=0; i<100; i++) {
                let c1 = cons[i % cons.length];
                let v = vowels[Math.floor(i / 5) % vowels.length];
                let c2 = cons[(i + 7) % cons.length];
                
                let combo = {
                    latin: c1.latin + v.latin.toLowerCase() + c2.latin.toLowerCase(),
                    cyrillic: c1.cyrillic + v.cyrillic.toLowerCase() + c2.cyrillic.toLowerCase(),
                    id: "combo_" + i
                };
                
                if (scriptKey === 'uyghur') {
                    combo.uyghur = c1.uyghur + v.uyghur.replace('ÿ¶', '') + c2.uyghur.replace('ÿ¶', '');
                } else {
                    combo.orkhon = c1.orkhon + v.orkhon + c2.orkhon;
                }
                
                combos.push(combo);
            }
            return combos;
        }

        let combinationData = [];
        let currentLevel = 1;
        let lives = 7;
        let streak = 0;
        let stakesEnabled = false;
        let firstCard = null, secondCard = null, lock = false;
        let allFlippedOnce = new Set();

        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let currentBrushColor = '#dda15e'; // Default color

        // Pleasant contrasting color palette for brush
        const brushColors = [
            '#e76f51', // Burnt Sienna
            '#f4a261', // Sandy Brown
            '#e9c46a', // Maize
            '#2a9d8f', // Persian Green
            '#264653', // Charcoal
            '#e63946', // Red Salsa
            '#f1faee', // Honeydew
            '#a8dadc', // Powder Blue
            '#457b9d', // Cerulean Blue
            '#1d3557', // Prussian Blue
            '#fb8500', // Orange (RYB)
            '#ffb703', // Selective Yellow
            '#8ecae6', // Baby Blue
            '#219ebc', // Carolina Blue
            '#023047', // Midnight Green
            '#d62828', // Fire Engine Red
            '#f77f00', // Orange Peel
            '#fcbf49', // Maximum Yellow Red
            '#eae2b7', // Dutch White
            '#d4a373', // Tan
            '#9d4edd', // Purple
            '#c77dff', // Mauve
            '#7209b7', // Purple (Munsell)
            '#560bad', // Trypan Blue
            '#3a0ca3', // Indigo
            '#4361ee', // Ultramarine Blue
            '#4cc9f0', // Vivid Sky Blue
            '#06ffa5', // Spring Green
            '#06d6a0', // Caribbean Green
            '#118ab2', // Blue NCS
            '#073b4c', // Rich Black
            '#ffd60a'  // Cyber Yellow
        ];

        function getColorForLetter(text) {
            // Generate consistent color based on letter
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = text.charCodeAt(i) + ((hash << 5) - hash);
            }
            return brushColors[Math.abs(hash) % brushColors.length];
        }

        // PROGRESS SAVING
        function saveProgress() {
            const progress = {
                level: currentLevel,
                lives: lives,
                scriptType: selectedScriptType,
                stakesEnabled: stakesEnabled,
                timestamp: Date.now()
            };
            localStorage.setItem('turkicAlphabetProgress', JSON.stringify(progress));
            updateProgressDisplay();
        }

        function loadProgress() {
            const saved = localStorage.getItem('turkicAlphabetProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    currentLevel = progress.level || 1;
                    lives = progress.lives || 7;
                    // Display on main screen
                    updateProgressDisplay();
                } catch (e) {
                    console.error('Failed to load progress:', e);
                }
            }
        }

        function updateProgressDisplay() {
            const badge = document.getElementById('savedProgress');
            if (currentLevel > 1) {
                badge.textContent = `üíæ SAVED: LEVEL ${currentLevel} | ‚ù§ ${lives}`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // REFERENCE SHEET
        function toggleReference() {
            const modal = document.getElementById('referenceModal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                generateReferenceTable();
            }
        }

        function generateReferenceTable() {
            const table = document.getElementById('referenceTable');
            let html = `
                <thead>
                    <tr>
                        <th>LATIN</th>
                        <th>CYRILLIC</th>
                        <th>UYGHUR<br>PERSO-ARABIC</th>
                        <th>OLD TURKIC<br>ORKHON</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Use Uyghur alphabet as base (has all letters)
            uyghurAlphabet.forEach((letter, idx) => {
                const orkhon = orkhonAlphabet[idx];
                html += `
                    <tr>
                        <td>${letter.latin}</td>
                        <td>${letter.cyrillic}</td>
                        <td class="native-script uyghur-cell">${letter.uyghur}</td>
                        <td class="native-script orkhon-cell">${orkhon.orkhon}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // Close modal when clicking outside
        document.getElementById('referenceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleReference();
            }
        });

        function selectScript(scriptType) {
            selectedScriptType = scriptType;
            
            if (scriptType === 'uyghur') {
                currentAlphabet = uyghurAlphabet;
                targetScriptKey = 'uyghur';
                document.getElementById('scriptHeader').textContent = 'Uyghur Kona Y√´ziq';
            } else {
                currentAlphabet = orkhonAlphabet;
                targetScriptKey = 'orkhon';
                document.getElementById('scriptHeader').textContent = 'Turkic Orkhon';
            }
            
            combinationData = getCombinations(currentAlphabet, targetScriptKey);
            
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
        }

        function backToMain() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('mainScreen').classList.add('active');
        }

        function showMenu() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('setupScreen').classList.add('active');
        }

        function updateLivesDisplay() {
            const container = document.getElementById('livesContainer');
            if(!stakesEnabled) { container.innerHTML = ''; return; }
            container.innerHTML = '‚ù§'.repeat(lives);
        }

        function startGame() {
            const mode = document.getElementById('gameMode').value;
            stakesEnabled = document.getElementById('stakesToggle').checked;
            lives = 7;
            streak = 0;
            currentLevel = 1;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(mode === 'memory') {
                document.getElementById('memoryScreen').classList.add('active');
                initMemory();
            } else {
                document.getElementById('drawScreen').classList.add('active');
                resizeCanvas();
                nextDrawing();
            }
            updateLivesDisplay();
        }

        function initMemory() {
            const board = document.getElementById('gameBoard');
            const isWord = document.getElementById('contentType').value === 'words';
            const data = isWord ? combinationData : currentAlphabet;
            const script = document.getElementById('scriptType').value;
            
            board.innerHTML = '';
            allFlippedOnce.clear();
            firstCard = null;
            secondCard = null;
            lock = false;
            
            const pairsCount = Math.min(3 + currentLevel, 10);
            const selected = [...data].sort(() => 0.5 - Math.random()).slice(0, pairsCount);
            
            let deck = [];
            selected.forEach(p => {
                const matchKey = p.id || p.latin;
                const isOrkhon = targetScriptKey === 'orkhon';
                
                deck.push({ 
                    t: p[script], 
                    m: matchKey, 
                    isUy: false, 
                    isOrkhon: false 
                });
                deck.push({ 
                    t: p[targetScriptKey], 
                    m: matchKey, 
                    isUy: targetScriptKey === 'uyghur', 
                    isOrkhon: targetScriptKey === 'orkhon' 
                });
            });
            deck.sort(() => 0.5 - Math.random());

            board.style.gridTemplateColumns = `repeat(${deck.length > 8 ? 4 : 3}, 1fr)`;
            deck.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.match = item.m;
                card.dataset.idx = idx;
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back ${item.isUy ? 'is-uyghur' : ''} ${item.isOrkhon ? 'is-orkhon' : ''}">${item.t}</div>
                    </div>`;
                card.onclick = handleFlip;
                board.appendChild(card);
            });
            document.getElementById('lvlDisplay').textContent = `LVL: ${String(currentLevel).padStart(2, '0')}`;
        }

        function handleFlip() {
            if(lock || this === firstCard || this.classList.contains('matched')) return;
            
            this.classList.add('flipped');
            allFlippedOnce.add(this.dataset.idx);
            
            if(!firstCard) { 
                firstCard = this; 
                return; 
            }
            
            secondCard = this; 
            lock = true;

            if(firstCard.dataset.match === secondCard.dataset.match) {
                // MATCH - Change color
                setTimeout(() => {
                    firstCard.classList.add('matched'); 
                    secondCard.classList.add('matched');
                    firstCard = null; 
                    secondCard = null; 
                    lock = false;
                    
                    if(stakesEnabled) {
                        streak++;
                        if(streak === 2) {
                            if(lives < 7) {
                                lives++;
                                updateLivesDisplay();
                                saveProgress();
                            }
                            streak = 0;
                        }
                    }

                    if(document.querySelectorAll('.matched').length === document.querySelectorAll('.card').length) {
                        setTimeout(() => { 
                            currentLevel++;
                            saveProgress();
                            alert("LEVEL CLEAR!"); 
                            initMemory(); 
                        }, 500);
                    }
                }, 300);
            } else {
                // MISS - Only lose life if all cards have been seen
                const totalCards = document.querySelectorAll('.card').length;
                const allSeen = allFlippedOnce.size === totalCards;
                
                setTimeout(() => { 
                    firstCard.classList.remove('flipped'); 
                    secondCard.classList.remove('flipped'); 
                    firstCard = null; 
                    secondCard = null; 
                    lock = false;
                    
                    // Only deduct life if all tiles have been checked at least once
                    if(stakesEnabled && allSeen) {
                        streak = 0;
                        lives--;
                        updateLivesDisplay();
                        saveProgress();
                        
                        if(lives <= 0) {
                            setTimeout(() => { 
                                alert("GAME OVER! TRY AGAIN."); 
                                currentLevel = 1;
                                lives = 7;
                                saveProgress();
                                showMenu(); 
                            }, 300);
                            return;
                        }
                    }
                }, 800);
            }
        }

        // DRAWING LOGIC
        function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function nextDrawing() {
            const isWord = document.getElementById('contentType').value === 'words';
            const data = isWord ? combinationData : currentAlphabet;
            const script = document.getElementById('scriptType').value;
            const item = data[Math.floor(Math.random() * data.length)];
            
            // Update target text
            const targetText = item[script];
            document.getElementById('drawTarget').textContent = targetText;
            
            // Set new brush color based on the letter
            currentBrushColor = getColorForLetter(targetText);
            
            // Update ghost preview with the native script
            const ghostLetter = document.getElementById('ghostLetter');
            ghostLetter.textContent = item[targetScriptKey];
            ghostLetter.className = 'ghost-preview';
            
            if (targetScriptKey === 'uyghur') {
                ghostLetter.classList.add('is-uyghur');
            } else if (targetScriptKey === 'orkhon') {
                ghostLetter.classList.add('is-orkhon');
            }
            
            clearCanvas();
        }

        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
            return { x, y };
        };

        canvas.addEventListener('mousedown', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', (e) => { 
            if(!drawing) return; e.preventDefault(); const p = getPos(e); 
            ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.strokeStyle = currentBrushColor;
            ctx.lineTo(p.x, p.y); ctx.stroke();
        });
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('touchstart', (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { 
            if(!drawing) return; 
            e.preventDefault(); 
            const p = getPos(e); 
            ctx.lineWidth = 5; 
            ctx.lineCap = 'round'; 
            ctx.strokeStyle = currentBrushColor;
            ctx.lineTo(p.x, p.y); 
            ctx.stroke(); 
        }, {passive: false});
        canvas.addEventListener('touchend', () => drawing = false);

        // Load saved progress on page load
        loadProgress();
    </script>
</body>
</html>
